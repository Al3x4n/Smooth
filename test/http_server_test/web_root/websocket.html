<!DOCTYPE html>
<html lang="en">
<head title="Websocket tests">
    <title>Websocket tests</title>
    <script lang="javascript">
        let socket = null;

        window.addEventListener('beforeunload', function () {
            if (socket != null) {
                socket.close();
            }
        });

        function connect() {
            if (socket == null) {
                let url = ((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + "/echo";
                socket = new WebSocket(url);

                // Connection opened
                socket.addEventListener('open', function (event) {
                    console.log("Connected!");
                    document.getElementById("status").innerText = "Connected";
                });

                socket.addEventListener('close', function (event) {
                    console.log("Disconnected: " + event.reason);
                    document.getElementById("status").innerText = "Disconnected";
                    socket = null;
                });

                // Listen for messages
                socket.addEventListener('message', function (event) {
                    var json = JSON.parse(event.data);
                    document.getElementById("data").value = json["data"];
                    document.getElementById("id").value = json["message_id"];
                    document.getElementById("length").value = json["length"];


                    document.getElementById("total_count").innerText = parseInt(document.getElementById("total_count").innerText) + parseInt(json["length"]);
                });
            }
        }

        function disconnect() {
            if (socket != null) {
                socket.close();
            }
        }

        function send_length(length) {
            document.getElementById("to_send").value = length;
            send();
        }

        function send() {
            var block_size = parseInt(document.getElementById("block_size").value);

            var remaining = parseInt(document.getElementById("to_send").value);

            console.log("Sending " + remaining + " bytes");

            var i = 0;

            var msg = {};

            while (remaining > block_size) {
                msg["message_id"] = i;
                msg["data"] = "a".repeat(block_size);
                msg["length"] = block_size;

                socket.send(JSON.stringify(msg));

                remaining -= block_size;
                ++i;
            }

            if (remaining > 0) {
                msg["message_id"] = i;
                msg["data"] = "a".repeat(remaining);
                msg["length"] = remaining;
                socket.send(JSON.stringify(msg));
            }
        }

        function reset_total() {
            document.getElementById("total_count").innerText = "0";
        }

    </script>
    </head>
    <body>
        <button onclick="connect();">Connect</button>
        <button onclick="disconnect();">Disconnect</button>
        <button onclick="send_length(125);">Send 125</button>
        <button onclick="send_length(65535);">Send 65k</button>
        <button onclick="send_length(80*1024);">Send 80k</button>
        <button onclick="send_length(1024*1024);">Send 1M</button>
        <button onclick="send_length(1024*1024*10);">Send 10M</button>
        <br/>
        <div id="status">Disconnected</div>
        <br/>
        <br/>
        Block size:<input type="text" id="block_size" value="4096"/>
        <br/>
        Amount to send: <input type="text" id="to_send" value="65535"/>
        <button onclick="send();">Send</button>
        <br/>
        Total count:
        <div id="total_count">0</div>
        <button onclick="reset_total();">Reset total</button>
        <br/>
        <br/>
        <label for="id">ID</label><textarea id="id"></textarea>
        <label for="length">Length</label><textarea id="length"></textarea>
        <label for="data">Data</label><textarea id="data"></textarea>
    </body>
</html>

