<!DOCTYPE html>
<html lang="en">
<head title="Websocket tests">
    <title>Websocket tests</title>
    <script lang="javascript">
        let socket = null;

        function connect() {
            if(socket == null) {
                let url = ((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + "/echo";
                socket = new WebSocket(url);

                // Connection opened
                socket.addEventListener('open', function (event) {
                    console.log("Connected!");
                    document.getElementById("status").innerText = "Connected";
                });

                socket.addEventListener('close', function (event) {
                    console.log("Disconnected: " + event.reason);
                    document.getElementById("status").innerText = "Disconnected";
                    socket = null;
                });

                // Listen for messages
                socket.addEventListener('message', function (event) {
                    console.log('Received ' + event.data.length, event.data);
                    document.getElementById("total_count").innerText = parseInt(document.getElementById("total_count").innerText) + parseInt(event.data.length);
                    document.getElementById("last_count").innerText = event.data.length;
                });
            }
        }

        function disconnect()
        {
            if(socket != null) {
                socket.close();
            }
        }

        function send_length(length)
        {
            document.getElementById("to_send").value = length;
            send();
        }

        function send() {
            let block_size = parseInt(document.getElementById("block_size").innerText);

            let remaining = parseInt(document.getElementById("to_send").value);

            console.log("Sending " + remaining + " bytes");

            while(remaining > block_size)
            {
                socket.send("a".repeat(block_size));
                remaining -= block_size;
            }

            if(remaining > 0)
            {
                socket.send("a".repeat(remaining));
            }
        }

        function reset_total() {
            document.getElementById("total_count").innerText = "0";
        }

    </script>
</head>
<body>
    <button onclick="connect();">Connect</button>
    <button onclick="disconnect();">Disonnect</button>
    <button onclick="send_length(125);">Send 125</button>
    <button onclick="send_length(65535);">Send 65k</button>
    <button onclick="send_length(80*1024);">Send 80k</button>
    <button onclick="send_length(1024*1024);">Send 1M</button>
    <button onclick="send_length(1024*1024*10);">Send 10M</button>
    <br/>
    <div id="status">Disconnected</div>
    <br/>
    <br/>
    Block size:<input type="text" id="block_size" value="4096"/>
    <br/>
    Amount to send: <input type="text" id="to_send" value="65535"/>
    <button onclick="send();">Send</button>
    <br/>
    Total count:
    <div id="total_count">0</div>
    <button onclick="reset_total();">Reset total</button>
    <br/>
    <br/>
    Last count:
    <div id="last_count">0</div>
</body>
</html>

